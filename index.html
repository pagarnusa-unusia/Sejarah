<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PAGARNUSA UNUSIA</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Poppins',sans-serif;background:linear-gradient(180deg,#f0fdfa,#f6f9f8);color:#333;}
    header{background:linear-gradient(90deg,#009688,#00796b);color:#fff;display:flex;align-items:center;justify-content:center;gap:12px;padding:16px;flex-wrap:wrap;position:sticky;top:0;z-index:10;}
    header img{width:65px;border-radius:50%;background:rgba(255,255,255,.15);padding:5px;}
    main{max-width:900px;background:#fff;margin:25px auto;padding:25px;border-radius:18px;box-shadow:0 4px 15px rgba(0,0,0,.1);}
    h2{color:#00796b;border-left:5px solid #009688;padding-left:10px;margin-top:25px;}
    p,li{margin-bottom:10px;text-align:justify;}
    img.center{display:block;margin:15px auto;max-width:100%;border-radius:10px;}
    table{width:100%;border-collapse:collapse;margin:20px 0;font-size:.95em;}
    th,td{border:1px solid #ddd;padding:8px;text-align:center;}
    thead{background:linear-gradient(90deg,#e0f2f1,#b2dfdb);}
    footer{background:linear-gradient(90deg,#00796b,#009688);color:#fff;text-align:center;padding:15px;margin-top:40px;}
    /* Overlay EYED */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;}
    .card{background:#fff;border-radius:14px;padding:20px;text-align:center;max-width:400px;width:90%;}
    .btn{border:none;border-radius:10px;padding:10px 20px;margin:6px;font-weight:600;cursor:pointer;}
    .btn-primary{background:linear-gradient(90deg,#009688,#00796b);color:#fff;}
    .btn-danger{background:#ffebee;color:#c62828;}
    video{width:100%;max-width:360px;border-radius:10px;display:none;}
    .status{margin-top:8px;font-size:.9em;min-height:22px;}
    .locked{filter:blur(3px);pointer-events:none;}
    @media(max-width:768px){header{flex-direction:column;}header h1{font-size:1.4em;}}
  </style>
</head>
<body>
  <div id="overlay" class="overlay">
    <div class="card">
      <h3>Verifikasi Wajah â€” EYED 1.0</h3>
      <p>Silakan nyalakan kamera dan cocokkan wajah Anda untuk membuka halaman.</p>
      <video id="video" autoplay playsinline muted></video>
      <div class="status" id="status"></div>
      <button class="btn btn-primary" id="startBtn">Mulai Kamera</button>
      <button class="btn btn-primary" id="snapBtn" style="display:none">Ambil Foto & Verifikasi</button>
      <button class="btn btn-danger" id="stopBtn" style="display:none">Hentikan</button>
      <canvas id="canvas" width="320" height="320" style="display:none"></canvas>
    </div>
  </div>

  <header>
    <img src="logopn.png" alt="Logo PAGARNUSA">
    <h1>PAGARNUSA UNUSIA</h1>
  </header>

  <main id="main" class="locked">
    <article>
      <h2>Sejarah</h2>
      <p>Pencak Silat Nahdlatul Ulama Pagar Nusa adalah organisasi bela diri di bawah NU.</p>
      <img src="salampn.jpg" alt="Salam Pagar Nusa" class="center">
      <h2>Hierarki Organisasi</h2>
      <ol>
        <li>Pimpinan Pusat (PP)</li><li>Pimpinan Wilayah (PW)</li><li>Pimpinan Cabang (PC)</li>
        <li>Pimpinan Anak Cabang (PAC)</li><li>Pimpinan Rayon</li><li>Pimpinan Ranting</li>
      </ol>
    </article>
  </main>

  <footer>&copy; 2025 PAGARNUSA UNUSIA. All rights reserved.</footer>

  <script>
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    const startBtn=document.getElementById('startBtn');
    const snapBtn=document.getElementById('snapBtn');
    const stopBtn=document.getElementById('stopBtn');
    const overlay=document.getElementById('overlay');
    const main=document.getElementById('main');
    const statusEl=document.getElementById('status');
    const ACCESS_KEY='pagar_eyed_access';
    const LABEL_FOLDER='./daftar wajah';
    const labels=['wajah1','wajah2','wajah3','wajah4','wajah5'];
    let stream=null,dbCache={};

    function log(msg,ok=true){statusEl.textContent=msg;statusEl.style.color=ok?'#2e7d32':'#c62828';}
    async function startCam(){
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
        video.srcObject=stream;video.style.display='block';
        startBtn.style.display='none';snapBtn.style.display='inline-block';stopBtn.style.display='inline-block';
        log('Kamera aktif, tekan "Ambil Foto & Verifikasi"');
      }catch(e){log('Tidak bisa membuka kamera',false);}
    }
    function stopCam(){if(stream){stream.getTracks().forEach(t=>t.stop());}video.style.display='none';startBtn.style.display='inline-block';snapBtn.style.display='none';stopBtn.style.display='none';log('Kamera dihentikan');}

    async function captureDataURL(){
      const ctx=canvas.getContext('2d');
      const w=Math.min(video.videoWidth,video.videoHeight);
      ctx.drawImage(video,(video.videoWidth-w)/2,(video.videoHeight-w)/2,w,w,0,0,320,320);
      return canvas.toDataURL('image/jpeg',0.9);
    }

    async function preloadRefs(){
      dbCache={};
      for(const n of labels){
        for(const ext of ['jpg','png']){
          try{
            const img=new Image();img.crossOrigin='anonymous';
            await new Promise((res,rej)=>{img.onload=res;img.onerror=rej;img.src=`${LABEL_FOLDER}/${n}.${ext}?_=${Date.now()}`;});
            const c=document.createElement('canvas');c.width=64;c.height=64;
            const x=c.getContext('2d');x.drawImage(img,0,0,64,64);
            const d=x.getImageData(0,0,64,64).data,g=new Float32Array(4096);
            for(let i=0,j=0;i<d.length;i+=4,j++)g[j]=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2];
            dbCache[n]=g;break;
          }catch{}
        }
      }
      const c=Object.keys(dbCache).length;
      log(c?`${c} referensi siap. Arahkan wajah Anda.`:'Tidak ada referensi ditemukan.',!!c);
    }

    async function dataURLtoGray(dataURL){
      return new Promise(res=>{
        const i=new Image();i.onload=()=>{
          const c=document.createElement('canvas');c.width=64;c.height=64;
          const x=c.getContext('2d');x.drawImage(i,0,0,64,64);
          const d=x.getImageData(0,0,64,64).data,g=new Float32Array(4096);
          for(let a=0,b=0;a<d.length;a+=4,b++)g[b]=0.2126*d[a]+0.7152*d[a+1]+0.0722*d[a+2];
          res(g);
        };i.src=dataURL;
      });
    }

    function diff(a,b){let s=0;for(let i=0;i<a.length;i++)s+=Math.abs(a[i]-b[i]);return s/a.length;}

    async function verify(){
      const data=await captureDataURL();
      const g=await dataURLtoGray(data);
      let best={l:null,s:1e9};
      for(const [l,v] of Object.entries(dbCache)){const sc=diff(g,v);if(sc<best.s)best={l,s:sc};}
      if(best.l&&best.s<28){sessionStorage.setItem(ACCESS_KEY,'true');unlock(best.l);stopCam();log('Berhasil login ('+best.l+')');}
      else log('Wajah tidak dikenali, coba lagi.',false);
    }

    function unlock(label){overlay.style.display='none';main.classList.remove('locked');console.log('Unlocked:',label);}
    function lock(){overlay.style.display='flex';main.classList.add('locked');}

    startBtn.onclick=startCam;
    stopBtn.onclick=stopCam;
    snapBtn.onclick=verify;
    window.addEventListener('load',async()=>{
      if(sessionStorage.getItem(ACCESS_KEY)==='true'){unlock('session');return;}
      lock();await preloadRefs();
    });
    window.addEventListener('beforeunload',stopCam);
  </script>
</body>
</html>
